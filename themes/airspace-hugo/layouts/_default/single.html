{{ define "main" }}

<!-- Sticky Progress Header -->
<div class="sticky-progress-header" id="stickyHeader">
  <div class="container-fluid">
    <div class="progress-header-content">
      <h4 class="progress-title">{{ .Title }}</h4>
      <!-- Add your logo here - replace with your logo path -->
      <a href="/">
        <img src="/images/logo.png" alt="Logo" class="progress-logo" id="stickyLogo">
      </a>
      <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </div>
  </div>
</div>

<!-- checking blog -->
{{ if or (eq .Section "post") (eq .Section "posts") (eq .Section "blog") (eq .Section "blogs") (eq .Section "news") (eq .Section "categories") (eq .Section "tags") }}

<section class="modern-article-wrapper">
  <div class="container-fluid">
    <div class="row">
      <!-- Left Sidebar - Metadata -->
      <div class="col-md-2">
        <aside class="article-metadata">
          <div class="meta-sticky">
            <!-- Date -->
            <div class="meta-section">
              <h5 class="meta-label">Published</h5>
              <time datetime="{{ .PublishDate.Format "2006-01-02" }}">
                {{ time.Format "January 2, 2006" .PublishDate }}
              </time>
            </div>
            
            <!-- Author -->
            <div class="meta-section">
              <h5 class="meta-label">Written by</h5>
              {{ $authors := slice }}{{ if reflect.IsSlice .Params.author }}{{ $authors = .Params.author }}{{ else }}{{ $authors = (slice .Params.author) }}{{ end -}}
              {{ range $index, $elements := $authors }}
              <a class="author-link" href="{{ `author/` | relLangURL }}{{ . | urlize }}">{{ . }}</a>{{ if ne $index (sub (len $authors) 1) }}, {{ end }}
              {{ end }}
            </div>
            
            <!-- Reading Time -->
            <div class="meta-section">
              <h5 class="meta-label">Reading time</h5>
              <span>{{ .ReadingTime }} min read</span>
            </div>
            
            <!-- Tags -->
            {{ if .Params.tags }}
            <div class="meta-section">
              <h5 class="meta-label">Topics</h5>
              <div class="tag-list-vertical">
                {{ range .Params.tags }}
                <a href="{{ `tags/` | relLangURL }}{{ . | urlize }}" class="tag-link">{{ . }}</a>
                {{ end }}
              </div>
            </div>
            {{ end }}
            
            <!-- Share -->
            <div class="meta-section">
              <h5 class="meta-label">Share</h5>
              <div class="share-buttons-vertical">
                <a href="https://twitter.com/intent/tweet?url={{ .Permalink | absURL }}&text={{ .Title }}" target="_blank" class="share-btn" title="Share on Twitter">
                  <i class="fab fa-twitter"></i>
                </a>
                <a href="https://www.facebook.com/sharer/sharer.php?u={{ .Permalink | absURL }}" target="_blank" class="share-btn" title="Share on Facebook">
                  <i class="fab fa-facebook-f"></i>
                </a>
                <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ .Permalink | absURL }}" target="_blank" class="share-btn" title="Share on LinkedIn">
                  <i class="fab fa-linkedin-in"></i>
                </a>
              </div>
            </div>
          </div>
        </aside>
      </div>
      
      <!-- Main Content -->
      <div class="col-md-7">
        <article class="modern-article">
          <!-- Headline -->
          <header class="article-header">
            <h1 class="article-title">{{ .Title }}</h1>
            
            <!-- Description/Excerpt -->
            {{ if .Params.description }}
            <div class="article-description">
              {{ .Params.description }}
            </div>
            {{ else if .Summary }}
            <div class="article-description">
              {{ .Summary | truncate 200 }}
            </div>
            {{ end }}
          </header>
          
          <!-- Main Image -->
          {{ with .Params.image }}
          <figure class="article-hero">
            <img src="{{ . | relURL }}" alt="{{ $.Title }}">
            {{ with $.Params.image_caption }}
            <figcaption>{{ . }}</figcaption>
            {{ end }}
          </figure>
          {{ end }}
          
          <!-- Article Content -->
          <div class="article-content">
            {{ .Content }}
          </div>
          
          <!-- Article Footer -->
          <footer class="article-footer">
            <!-- Author Bio -->
            {{ if .Params.author }}
            <div class="author-bio-section">
              <h4>More about the author: </h4>
              {{ $authors := slice }}{{ if reflect.IsSlice .Params.author }}{{ $authors = .Params.author }}{{ else }}{{ $authors = (slice .Params.author) }}{{ end -}}
              {{ range $index, $elements := $authors }}
              <a class="author-link" href="{{ `author/` | relLangURL }}{{ . | urlize }}">{{ . }}</a>{{ if ne $index (sub (len $authors) 1) }}, {{ end }}
              {{ end }}
            </div>
            {{ end }}
            
            <!-- Related Articles -->
            <div class="related-articles-section">
              <h4 class="section-title">You might also like</h4>
              <div class="related-posts">
                {{ $currentPermalink := .Permalink }}
                {{ $currentPost := . }}
                {{ $relatedPosts := slice }}
                
                <!-- Get all posts except current one -->
                {{ $allPosts := where (where site.Pages "Type" "post") "Permalink" "!=" $currentPermalink }}
                
                <!-- Find posts with matching categories -->
                {{ if .Params.categories }}
                  {{ $categoryMatches := slice }}
                  {{ range $allPosts }}
                    {{ if .Params.categories }}
                      {{ $commonCategories := intersect $currentPost.Params.categories .Params.categories }}
                      {{ if gt (len $commonCategories) 0 }}
                        {{ $categoryMatches = $categoryMatches | append . }}
                      {{ end }}
                    {{ end }}
                  {{ end }}
                  {{ $relatedPosts = $relatedPosts | append ($categoryMatches | shuffle | first 3) }}
                {{ end }}
                
                <!-- If we need more posts, find posts with matching tags -->
                {{ if lt (len $relatedPosts) 3 }}
                  {{ if .Params.tags }}
                    {{ $tagMatches := slice }}
                    {{ range $allPosts }}
                      {{ if .Params.tags }}
                        {{ $commonTags := intersect $currentPost.Params.tags .Params.tags }}
                        {{ if gt (len $commonTags) 0 }}
                          <!-- Exclude posts already in relatedPosts -->
                          {{ $alreadyIncluded := false }}
                          {{ range $relatedPosts }}
                            {{ if eq .Permalink $.Permalink }}
                              {{ $alreadyIncluded = true }}
                            {{ end }}
                          {{ end }}
                          {{ if not $alreadyIncluded }}
                            {{ $tagMatches = $tagMatches | append . }}
                          {{ end }}
                        {{ end }}
                      {{ end }}
                    {{ end }}
                    {{ $needed := sub 3 (len $relatedPosts) }}
                    {{ $relatedPosts = $relatedPosts | append ($tagMatches | shuffle | first $needed) }}
                  {{ end }}
                {{ end }}
                
                <!-- If we still need more posts, fill with recent posts -->
                {{ if lt (len $relatedPosts) 3 }}
                  {{ $recentPosts := slice }}
                  {{ range $allPosts | first 10 }}
                    <!-- Exclude posts already in relatedPosts -->
                    {{ $alreadyIncluded := false }}
                    {{ range $relatedPosts }}
                      {{ if eq .Permalink $.Permalink }}
                        {{ $alreadyIncluded = true }}
                      {{ end }}
                    {{ end }}
                    {{ if not $alreadyIncluded }}
                      {{ $recentPosts = $recentPosts | append . }}
                    {{ end }}
                  {{ end }}
                  {{ $needed := sub 3 (len $relatedPosts) }}
                  {{ $relatedPosts = $relatedPosts | append ($recentPosts | first $needed) }}
                {{ end }}
                
                <!-- Display the related posts -->
                {{ range first 3 $relatedPosts }}
                  <article class="related-post-item">
                    <h5 class="related-post-title">
                      <a href="{{ .Permalink }}">{{ .Title }}</a>
                    </h5>
                    <div class="related-post-meta">
                      <time datetime="{{ .Date.Format "2006-01-02" }}">
                        {{ .Date.Format "January 2, 2006" }}
                      </time>
                      {{ with .Params.author }}
                      â€¢ {{ if reflect.IsSlice . }}{{ delimit . ", " }}{{ else }}{{ . }}{{ end }}
                      {{ end }}
                    </div>
                    {{ with .Params.description }}
                    <p class="related-post-excerpt">{{ . | truncate 120 }}</p>
                    {{ else }}
                    <p class="related-post-excerpt">{{ .Summary | truncate 120 }}</p>
                    {{ end }}
                  </article>
                {{ end }}
              </div>
            </div>
          </footer>
          
          <!-- Comments -->
          {{ with site.Params.DisqusShortname }}
          <section class="article-comments">
            <h3>Join the conversation</h3>
            {{ template "_internal/disqus.html" . }}
          </section>
          {{ end }}
        </article>
      </div>
      
      <!-- Right Sidebar -->
      <div class="col-md-3">
        <aside class="article-sidebar">
          {{ partial "blog-sidebar.html" . }}
        </aside>
      </div>
    </div>
  </div>
</section>

<!-- Sticky Header JavaScript -->
<script>
// Sticky Progress Header Functionality
document.addEventListener('DOMContentLoaded', function() {
  const stickyHeader = document.getElementById('stickyHeader');
  const progressBar = document.getElementById('progressBar');
  const articleContent = document.querySelector('.article-content');
  const articleHeader = document.querySelector('.article-header');
  
  if (!stickyHeader || !progressBar || !articleContent) {
    return; // Exit if required elements are not found
  }
  
  let isHeaderVisible = false;
  let ticking = false;
  
  // Calculate the trigger point (after article header)
  const getTriggerPoint = () => {
    if (articleHeader) {
      return articleHeader.offsetTop + articleHeader.offsetHeight;
    }
    return 300; // Fallback value
  };
  
  // Calculate reading progress
  const calculateProgress = () => {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const documentHeight = document.documentElement.scrollHeight;
    const windowHeight = window.innerHeight;
    
    // Calculate progress based on how close we are to the bottom of the page
    const scrollableDistance = documentHeight - windowHeight;
    const scrolledPercentage = Math.min(100, (scrollTop / scrollableDistance) * 100);
    
    return Math.max(0, scrolledPercentage);
  };
  
  // Update progress bar
  const updateProgressBar = () => {
    const progress = calculateProgress();
    progressBar.style.width = progress + '%';
  };
  
  // Show/hide sticky header
  const toggleStickyHeader = () => {
    const triggerPoint = getTriggerPoint();
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    
    if (scrollTop > triggerPoint && !isHeaderVisible) {
      stickyHeader.classList.add('visible');
      document.body.classList.add('sticky-header-visible');
      isHeaderVisible = true;
    } else if (scrollTop <= triggerPoint && isHeaderVisible) {
      stickyHeader.classList.remove('visible');
      document.body.classList.remove('sticky-header-visible');
      isHeaderVisible = false;
    }
  };
  
  // Main scroll handler
  const handleScroll = () => {
    if (!ticking) {
      requestAnimationFrame(() => {
        toggleStickyHeader();
        updateProgressBar();
        ticking = false;
      });
      ticking = true;
    }
  };
  
  // Throttled resize handler
  let resizeTimeout;
  const handleResize = () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      toggleStickyHeader();
      updateProgressBar();
    }, 150);
  };
  
  // Initialize
  const init = () => {
    // Set initial state
    updateProgressBar();
    toggleStickyHeader();
    
    // Add event listeners
    window.addEventListener('scroll', handleScroll, { passive: true });
    window.addEventListener('resize', handleResize, { passive: true });
  };
  
  // Start the functionality
  init();
  
  // Clean up function (useful for single-page applications)
  window.stickyHeaderCleanup = () => {
    window.removeEventListener('scroll', handleScroll);
    window.removeEventListener('resize', handleResize);
    clearTimeout(resizeTimeout);
  };
});
</script>

<!-- regular page -->
{{ else -}}
{{ .Render "default" }}
{{- end }}
<!-- /regular page -->

{{ end }}