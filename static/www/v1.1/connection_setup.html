<!DOCTYPE html>
<html>
<head>
  <title>Kosoku - WiFi Setup</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#x2699;&#xFE0F;</text></svg>">
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <style>
    body{font-family:Arial,sans-serif;margin:0;padding:20px;line-height:1.6}
    h1{color:#f44236}
    .config-form{background-color:#f8f8f8;padding:20px;border-radius:4px;max-width:500px;margin:0 auto}
    .form-group{margin-bottom:15px}
    .form-group label{display:block;margin-bottom:5px;font-weight:bold}
    .form-group input{width:calc(100% - 18px);padding:8px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box}
    button{padding:10px 15px;background-color:#f44236;color:white;border:none;border-radius:4px;cursor:pointer;width:100%}
    button:hover{background-color:#d32f2f}
    .section{background-color:white;padding:15px;margin-bottom:15px;border-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
    .section h3{margin-top:0;color:#f44236}
    .message{padding:10px;margin-top:10px;border-radius:4px}
    .success{background-color:#d4edda;color:#155724}
    .error{background-color:#f8d7da;color:#721c24}
    .loading-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);z-index:1000}
    .loading-spinner{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:white;width:200px}
    .spinner{width:50px;height:50px;border:5px solid #f3f3f3;border-top:5px solid #f44236;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <h1>WiFi Setup</h1>
  
  <div class='config-form' id='wifiForm'>
    <div class='section'>
      <h3>WiFi Connection</h3>
      <p>Enter your WiFi credentials to connect the Kosoku device to your network.</p>
      <div class='form-group'>
        <label for='wifi_ssid'>WiFi SSID</label>
        <input type='text' id='wifi_ssid' name='wifi_ssid' placeholder='Your network name'>
      </div>
      <div class='form-group'>
        <label for='wifi_password'>WiFi Password</label>
        <input type='password' id='wifi_password' name='wifi_password' placeholder='Your network password'>
      </div>
    </div>

    <div id='messageArea'></div>
    
    <button id='connectButton' onclick='connectWifi()'>Connect</button>
  </div>
  
  <div class='loading-overlay' id='loadingOverlay'>
    <div class='loading-spinner'>
      <div class='spinner'></div>
      <p>Connecting to WiFi...</p>
    </div>
  </div>
  
  <script>
    function connectWifi() {
      const ssid = document.getElementById('wifi_ssid').value.trim();
      const password = document.getElementById('wifi_password').value.trim();
      
      if (ssid === '') {
        showMessage('Please enter a WiFi SSID', false);
        return;
      }
      
      // Show loading overlay
      document.getElementById('loadingOverlay').style.display = 'block';
      document.getElementById('connectButton').disabled = true;
      
      // Send only the SSID and password to the ESP32
      fetch('/api/wifi-connect', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'ssid=' + encodeURIComponent(ssid) + '&password=' + encodeURIComponent(password)
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to connect to WiFi network');
        }
        return response.json();
      })
      .then(result => {
        // Hide loading overlay
        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('connectButton').disabled = false;
        
        // Extract hostname and display success message
        const hostname = result.hostname;
        showMessage("Success!\n\n&#x26A0;&#xFE0F; Please turn your device upside down NOW &#x26A0;&#xFE0F;\n\n", true, hostname);
      })
      .catch(error => {
        // Hide loading overlay
        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('connectButton').disabled = false;
        showMessage(error.message, false);
      });
    }
    
    function showMessage(message, isSuccess, hostname = null) {
      const messageArea = document.getElementById('messageArea');
      messageArea.innerHTML = `<div class='message ${isSuccess ? 'success' : 'error'}'>${message}</div>`;
      
      if (isSuccess) {
        // Start countdown after 5 seconds
        setTimeout(() => {
          let secondsLeft = 10;
          
          // Create countdown display
          messageArea.innerHTML = `
            <div class='message success'>
              ${message}<br><br>
              Redirecting in <span id="countdown">${secondsLeft}</span>s.\nAccess http://${hostname} manually if needed\n
            </div>
          `;
          
          // Update countdown every second
          const countdownInterval = setInterval(() => {
            secondsLeft--;
            document.getElementById('countdown').textContent = secondsLeft;
            
            if (secondsLeft <= 0) {
              clearInterval(countdownInterval);
              window.location.href = 'http://' + hostname;
            }
          }, 1000);
        }, 5000);
      }
    }
  </script>
</body>
</html>